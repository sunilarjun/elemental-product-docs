name: Accessibility Report

on:
  pull_request:
    paths:
      - 'docs/**'
      - 'versions/**' 
    branches:
      - main

jobs:
  alfa_report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        # Important: Fetch the target branch history for the git diff to work correctly
        with:
          fetch-depth: 0 
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install Dependencies
        run: npm install 

      # --- 1. Identify Changed Files using Git ---
      - name: Get Changed Asciidoc Files
        id: changed-files-git
        run: |
          # 1. Compare the current PR commit (HEAD) with the base branch (e.g., main)
          # 2. Filter the results to only include added (A), modified (M), or renamed (R) files
          # 3. Filter the paths to only include .adoc files under docs/ or versions/
          
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD \
            --diff-filter=AMR -- '*.adoc' | \
            grep -E '^(docs|versions)/.+\.adoc$' | tr '\n' ' ')
          
          # Set the list as an output variable for the next step
          echo "changed_files_list=${CHANGED_FILES}" >> $GITHUB_OUTPUT
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No relevant Asciidoc files were modified. Skipping Alfa audit."
            echo "skip_audit=true" >> $GITHUB_OUTPUT
          else
            echo "Files changed: $CHANGED_FILES"
            echo "skip_audit=false" >> $GITHUB_OUTPUT
          fi

      # Check if any .adoc files were changed. Exit if not.
      - name: Skip Audit If No Asciidoc Changes
        if: steps.changed-files-git.outputs.skip_audit == 'true'
        run: exit 0
      
      # --- 2. Build Antora Site ---
      - name: Run Antora Build
        run: npx antora elemental-playbook-local.yml 
        
      # --- 3. Dynamic Targeted URL Setup ---
      - name: Generate Targeted Alfa URLs List
        # Pass the list of changed files from the previous step's output
        env:
          CHANGED_FILES: ${{ steps.changed-files-git.outputs.changed_files_list }}
        run: node generate-alfa-urls-targeted.js
        
      # --- 4. Start Server and Run Audit ---
      
      - name: Start Static Docs Server in Background
        run: npx http-server build/site -p 8080 & 

      - name: Run Siteimprove Alfa Audit and Generate Report
        run: |
          URL_LIST=$(cat alfa-urls.txt)
          echo "Auditing the following URLs: $URL_LIST"
          npx @siteimprove/alfa-cli audit --urls $URL_LIST --json > alfa-report.json || true
        
      - name: Upload Alfa Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: alfa-accessibility-report-${{ github.sha }}
          path: alfa-report.json
          retention-days: 7