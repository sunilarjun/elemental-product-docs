name: Generate Alfa Accessibility Report

on:
  pull_request:
    # Only run the workflow if files within the 'docs/' directory are modified
    paths:
      - 'docs/**'
      - 'versions/**'
    types: [opened, edited, synchronize, reopened]

jobs:
  alfa_report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install Dependencies
        # Assumes Antora, http-server, and the necessary Siteimprove Alfa packages
        # (@siteimprove/alfa-cli, @siteimprove/alfa-scraper, etc.) are in package.json
        run: npm install 

      # --- Phase 1: Build Antora Site ---
      - name: Run Antora Build
        # This converts Asciidoc to static HTML
        run: npx antora elemental-playbook-local.yml 
        
      # --- Phase 2: Dynamic URL Setup ---
      - name: Generate Alfa URLs List
        # This executes the custom script (generate-alfa-urls.js) to find all HTML files
        run: node generate-alfa-urls.js
        
      # --- Phase 3: Start Server and Run Audit ---
      
      - name: Start Static Docs Server in Background
        # Serve the generated HTML files for the Alfa scraper to access.
        # Ensure the path (build/site) and port (8080) match your Antora build and script config.
        run: npx http-server build/site -p 8080 & 

      - name: Run Siteimprove Alfa Audit and Generate Report
        # 1. Read URLs from the file created by the script (alfa-urls.txt).
        # 2. Use the Alfa CLI with the scrape command to test pages.
        # 3. Output the results to a structured JSON file.
        run: |
          URL_LIST=$(cat alfa-urls.txt)
          npx @siteimprove/alfa-cli audit --urls $URL_LIST --json > alfa-report.json || true
        
      - name: Upload Alfa Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: alfa-accessibility-report-${{ github.sha }}
          path: alfa-report.json
          retention-days: 7